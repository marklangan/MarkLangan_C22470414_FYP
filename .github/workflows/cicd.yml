name: CI/CD to AKS

on:
  push:
    branches: [ "main" ]
    paths:
      - 'app/**'
      - 'k8s/**'
      - '.github/workflows/cicd.yml'
      - 'Dockerfile'
    workflow_dispatch: {}

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
  ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}

jobs:
  build-and-deploy:
    runs-on: self-hosted
    defaults:
      run:
        shell: powershell
        working-directory: app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: Install dependencies
        run: npm ci
      
      - name: Dependency audit (npm audit) - report only
        working-directory: app
        run: |
          npm audit --omit=dev
          if ($LASTEXITCODE -ne 0) {
            Write-Host "npm audit found vulnerabilities (report-only mode, not failing)"
            exit 0
          }

      - name: Run tests
        run: npm test

      - name: Ensure ACR login (via az)
        run: az acr login --name fypcicdregistrymarkl

      - name: Install Trivy (report-only)
        shell: powershell
        run: |
          $ProgressPreference = 'SilentlyContinue'

          # Get latest Trivy release info from GitHub API
          $release = Invoke-RestMethod -Uri "https://api.github.com/repos/aquasecurity/trivy/releases/latest"
          $tag = $release.tag_name              # e.g. "v0.66.0"
          $ver = $tag.TrimStart('v')            # e.g. "0.66.0"

          # Trivy Windows asset naming format: trivy_<ver>_windows-64bit.zip
          $url = "https://github.com/aquasecurity/trivy/releases/download/$tag/trivy_${ver}_windows-64bit.zip"
          Write-Host "Downloading Trivy from: $url"

          Invoke-WebRequest -Uri $url -OutFile "trivy.zip"

          $dest = "$env:RUNNER_TEMP\trivy"
          New-Item -ItemType Directory -Force -Path $dest | Out-Null
          Expand-Archive "trivy.zip" -DestinationPath $dest -Force

          # Add to PATH for subsequent steps in the same job
          echo "$dest" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          trivy --version




      - name: Build and push Docker image
        run: |
          $IMAGE_TAG = "${{ github.sha }}"
          $IMAGE = "$env:ACR_LOGIN_SERVER/fyp-app:$IMAGE_TAG"
          docker build -t "$IMAGE" .

          trivy image --severity HIGH,CRITICAL --exit-code 0 "$IMAGE"

          docker push "$IMAGE"

      - name: Set AKS context
        run: |
          az aks get-credentials --resource-group $env:AZURE_RESOURCE_GROUP --name $env:AKS_CLUSTER_NAME --overwrite-existing

      - name: Deploy to AKS
        run: |

          $IMAGE_TAG = "${{ github.sha }}"
          $IMAGE = "$env:ACR_LOGIN_SERVER/fyp-app:$IMAGE_TAG"

          kubectl apply -f ../k8s/

          kubectl set image deployment/fyp-app-deployment fyp-app=$IMAGE --record=true


          kubectl rollout status deployment/fyp-app-deployment


