name: CI/CD to AKS

on:
  push:
    branches: [ "main" ]

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
  ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}

jobs:
  build-and-deploy:
    runs-on: self-hosted
    defaults:
      run:
        shell: pwsh
        working-directory: app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Ensure ACR login (uses env secrets)
        run: |
          echo $env:ACR_PASSWORD | docker login $env:ACR_LOGIN_SERVER -u $env:ACR_USERNAME --password-stdin

      - name: Build and push Docker image
        run: |
          $IMAGE_TAG = "${{ github.sha }}"
          docker build -t "$env:ACR_LOGIN_SERVER/fyp-app:latest" .
          docker tag "$env:ACR_LOGIN_SERVER/fyp-app:latest" "$env:ACR_LOGIN_SERVER/fyp-app:$IMAGE_TAG"
          docker push "$env:ACR_LOGIN_SERVER/fyp-app:latest"
          docker push "$env:ACR_LOGIN_SERVER/fyp-app:$IMAGE_TAG"

      - name: Set AKS context
        run: |
          az aks get-credentials --resource-group $env:AZURE_RESOURCE_GROUP --name $env:AKS_CLUSTER_NAME --overwrite-existing

      - name: Deploy to AKS
        run: |
          kubectl apply -f ../k8s/
          kubectl rollout status deployment/fyp-app-deployment

